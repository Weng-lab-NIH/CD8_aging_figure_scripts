---
title: "Figure6"
author: "Humza Hemani"
output: html_notebook
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

# Data Repo
knitr::opts_knit$set(root.dir = normalizePath("/home/jon/Documents/weng_lab/figure_repo")) 

```

```{r Figure6}
# 7.1.0_ageChange_2
rm(list=ls())
library(lme4)
library(broom.mixed)
library(lmerTest)
library(tidyverse)
library(MuMIn)

# Load Mutations Data:

mut_all <- read_csv('./7.0.0_Mutations_normalized_lmAdjusted_rm0.csv', guess_max = 100000) %>% 
  filter(cell == 'CD8')

predictions <- read_csv('./7.0.0_Mutations_predictions.csv')
mut_all <- mut_all %>% inner_join(predictions, by = 'barcode')
# Show Relationship to Age:

colors <- tibble(subset = c('N','CM','EM','RA'), color = c('forestgreen','dodgerblue3','orangered','purple3'))

# Filter unnecessary cells:
mut_all <- mut_all %>% filter(Age > 5, subset != 'EFF')
mut_all$Group <- substr(mut_all$Code, 1, 2)
mut_all$prediction_add <- mut_all$prediction + mut_all$bi

# Age vs Predicted Age by subsets:

mut_all$subset <- factor(mut_all$subset, levels = colors$subset)
m.p<-ggplot(mut_all, aes(x=Age,y=prediction_add)) +
  theme_minimal() + theme_bw(base_size=7) + theme(aspect.ratio = 1) +
  geom_smooth(method = 'lm', aes(group = subset, color = subset), se = F) +
  scale_color_manual(values = colors$color) +
  coord_cartesian(xlim = c(20,90), ylim = c(20,90)) +
  scale_x_continuous(breaks = seq(20,90,10)) +
  scale_y_continuous(breaks = seq(20,90,10))
ggsave("fig1d.png")
print(m.p)
# mixed effect line:
final <- tibble()
for (i in unique(mut_all$subset)) {
  mut_sub <- mut_all[mut_all$subset == i,]
  model <- lmer(prediction_add~Age + (1|Group), REML = T, mut_sub) # This is the actual linear model generated, change this to preferred model if necessary
  #summary(model)
  sum_test <- step(model,reduce.fixed = FALSE, reduce.random = FALSE)
  summary <- broom.mixed::tidy(model)
  summary2 <- broom.mixed::augment(model)
  age_p <- sum_test[["fixed"]][["Pr(>F)"]][[1]]
  co <- as.numeric(summary[2,4])
  intercept <- as.numeric(summary[1,4])
  add <- tibble(subset = i, age_p = age_p, co = co, intercept = intercept)
  final <- bind_rows(final, add)
}
write.csv(final, './7.1.0_Mutations_AgeVsPredictedAge_subset_ME.csv', row.names = F)


# Plot positive cells for their Expression Across Age:
# plot log2 and raw data
# Age and Predicted Age

pos_mut <- mut_all %>% filter(num_mut > 0)

# generate line:
final <- tibble()
for (i in unique(mut_all$subset)) {
  mut_sub <- pos_mut[pos_mut$subset == i,]
  model <- lm(scale_mut~prediction_add, mut_sub)
  #summary(model)
  cor <- cor(mut_sub$scale_mut, mut_sub$prediction_add)
  sum_test <- summary(model)
  age_p <- sum_test[["coefficients"]][2,4]
  co <- sum_test[["coefficients"]][2,1]
  intercept <- sum_test[["coefficients"]][1,1]
  add <- tibble(subset = i, age_p = age_p, co = co, intercept = intercept, cor = cor)
  final <- bind_rows(final, add)
}
write.csv(final, './7.1.0_log2ScalePosNumMutationsVsPredictedAge_subset_LM_RawRm0NB.csv', row.names = F)

final$subset <- factor(final$subset, levels = colors$subset)
m.p<-ggplot(pos_mut, aes(x=prediction_add, y=scale_mut)) +
  theme_minimal() + theme_bw(base_size = 7) + theme(aspect.ratio = 1) +
  geom_point(alpha = 0) +
  #geom_boxplot(aes(fill = factor(Age))) +
  geom_abline(data = final, aes(slope = co, intercept = intercept, color = subset)) +
  coord_cartesian(xlim = c(20,90), ylim = c(9,15)) +
  scale_x_continuous(breaks = seq(20,90,10)) +
  scale_color_manual(values = colors$color) +
  scale_y_continuous(breaks = seq(7,20,1))
ggsave("fig4e.png")
print(m.p)
write.csv(pos_mut, "fig4e_pos_mut.csv")
```